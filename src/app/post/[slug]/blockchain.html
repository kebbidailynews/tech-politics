<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Payments App</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
        <h1 class="text-2xl font-bold mb-4 text-center">Blockchain Payments</h1>
        <div class="flex mb-4">
            <button id="paymentsTab" class="flex-1 py-2 px-4 bg-blue-500 text-white rounded-l hover:bg-blue-600">Payments</button>
            <button id="newsTab" class="flex-1 py-2 px-4 bg-gray-300 text-gray-700 rounded-r hover:bg-gray-400">Crypto News</button>
        </div>
        <div id="paymentsContent">
            <div id="walletStatus" class="mb-4 text-center"></div>
            <div id="balance" class="mb-4 text-center"></div>
            <button id="connectWallet" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 mb-4">Connect Wallet</button>
            <div id="paymentForm" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Payment Type</label>
                    <select id="paymentType" class="mt-1 block w-full border rounded py-2 px-3">
                        <option value="eth">ETH</option>
                        <option value="usdc">USDC</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Recipient Address</label>
                    <input id="recipient" type="text" class="mt-1 block w-full border rounded py-2 px-3" placeholder="0x...">
                    <p id="recipientError" class="text-red-500 text-sm hidden">Invalid address</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Amount</label>
                    <input id="amount" type="number" step="0.01" class="mt-1 block w-full border rounded py-2 px-3" placeholder="0.0">
                    <p id="amountError" class="text-red-500 text-sm hidden">Invalid amount</p>
                </div>
                <button id="sendPayment" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 disabled:bg-gray-400" disabled>Send Payment</button>
            </div>
            <div id="message" class="mt-4 text-center"></div>
            <div id="txHistory" class="mt-4">
                <h2 class="text-lg font-semibold mb-2">Transaction History</h2>
                <ul id="txList" class="space-y-2"></ul>
            </div>
        </div>
        <div id="newsContent" class="hidden">
            <div class="flex justify-between mb-4">
                <h2 class="text-lg font-semibold">Crypto News</h2>
                <button id="refreshNews" class="bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-600">Refresh</button>
            </div>
            <ul id="newsList" class="space-y-2"></ul>
        </div>
    </div>

    <script>
        let web3;
        let account;
        const USDC_ADDRESS = "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"; // Mainnet USDC address (replace with testnet for testing)
        const USDC_ABI = [
            {
                "constant": false,
                "inputs": [
                    {"name": "_to", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "transfer",
                "outputs": [{"name": "", "type": "bool"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "_owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "balance", "type": "uint256"}],
                "type": "function"
            }
        ];

        // Mock news data (simulating API response)
        const mockNews = [
            { title: "Bitcoin Tops $109K, Ethereum Gains 6%", url: "https://cryptorank.io/news", date: "2025-07-03" },
            { title: "Ripple and SEC End Five-Year Legal Conflict", url: "https://t.co/67UPxE5SSj", date: "2025-06-28" },
            { title: "US Congress Plans 'Crypto Week' for Legislation", url: "https://cryptorank.io/news", date: "2025-07-04" },
            { title: "Nobitex Exchange Recovers from $100M Hack", url: "https://coinpedia.org/news", date: "2025-07-05" },
            { title: "Bitcoin ETFs See $588M Inflows", url: "https://t.co/UvD5FqMvto", date: "2025-06-27" }
        ];

        function showTab(tab) {
            document.getElementById('paymentsTab').classList.toggle('bg-blue-500', tab === 'payments');
            document.getElementById('paymentsTab').classList.toggle('bg-gray-300', tab !== 'payments');
            document.getElementById('paymentsTab').classList.toggle('text-white', tab === 'payments');
            document.getElementById('paymentsTab').classList.toggle('text-gray-700', tab !== 'payments');
            document.getElementById('newsTab').classList.toggle('bg-blue-500', tab === 'news');
            document.getElementById('newsTab').classList.toggle('bg-gray-300', tab !== 'news');
            document.getElementById('newsTab').classList.toggle('text-white', tab === 'news');
            document.getElementById('newsTab').classList.toggle('text-gray-700', tab !== 'news');
            document.getElementById('paymentsContent').classList.toggle('hidden', tab !== 'payments');
            document.getElementById('newsContent').classList.toggle('hidden', tab !== 'news');
        }

        function displayNews() {
            const newsList = document.getElementById('newsList');
            newsList.innerHTML = '';
            mockNews.forEach(news => {
                const li = document.createElement('li');
                li.className = 'text-sm text-gray-600';
                li.innerHTML = `<a href="${news.url}" target="_blank" class="text-blue-500 hover:underline">${news.title}</a> (${news.date})`;
                newsList.appendChild(li);
            });
        }

        async function initWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const accounts = await web3.eth.getAccounts();
                    account = accounts[0];
                    document.getElementById('walletStatus').innerText = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
                    document.getElementById('connectWallet').classList.add('hidden');
                    document.getElementById('paymentForm').classList.remove('hidden');
                    updateBalance();
                } catch (error) {
                    showMessage('Failed to connect wallet: ' + error.message, 'error');
                }
            } else {
                showMessage('Please install MetaMask!', 'error');
            }
        }

        async function updateBalance() {
            const ethBalance = await web3.eth.getBalance(account);
            const usdcContract = new web3.eth.Contract(USDC_ABI, USDC_ADDRESS);
            const usdcBalance = await usdcContract.methods.balanceOf(account).call();
            document.getElementById('balance').innerText = `ETH: ${web3.utils.fromWei(ethBalance, 'ether').slice(0, 6)} | USDC: ${web3.utils.fromWei(usdcBalance, 'mwei').slice(0, 6)}`;
        }

        function validateInputs() {
            const recipient = document.getElementById('recipient').value;
            const amount = document.getElementById('amount').value;
            const recipientError = document.getElementById('recipientError');
            const amountError = document.getElementById('amountError');
            let isValid = true;

            if (!web3.utils.isAddress(recipient)) {
                recipientError.classList.remove('hidden');
                isValid = false;
            } else {
                recipientError.classList.add('hidden');
            }

            if (isNaN(amount) || amount <= 0) {
                amountError.classList.remove('hidden');
                isValid = false;
            } else {
                amountError.classList.add('hidden');
            }

            angular.element(document.getElementById('sendPayment')).disabled = !isValid;
        }

        async function sendPayment() {
            const recipient = document.getElementById('recipient').value;
            const amount = document.getElementById('amount').value;
            const paymentType = document.getElementById('paymentType').value;
            showMessage('Processing transaction...', 'info');

            try {
                let tx;
                if (paymentType === 'eth') {
                    const amountWei = web3.utils.toWei(amount, 'ether');
                    tx = await web3.eth.sendTransaction({
                        from: account,
                        to: recipient,
                        value: amountWei
                    });
                } else {
                    const usdcContract = new web3.eth.Contract(USDC_ABI, USDC_ADDRESS);
                    const amountMwei = web3.utils.toWei(amount, 'mwei');
                    tx = await usdcContract.methods.transfer(recipient, amountMwei).send({ from: account });
                }
                showMessage(`Payment sent! Tx Hash: ${tx.transactionHash}`, 'success');
                addToHistory(tx.transactionHash, recipient, amount, paymentType);
                updateBalance();
            } catch (error) {
                showMessage('Payment failed: ' + error.message, 'error');
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerText = text;
            messageDiv.className = `mt-4 text-center ${type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-500' : 'text-blue-500'}`;
        }

        function addToHistory(txHash, recipient, amount, type) {
            const txList = document.getElementById('txList');
            const li = document.createElement('li');
            li.className = 'text-sm text-gray-600';
            li.innerHTML = `${type.toUpperCase()} ${amount} to ${recipient.slice(0, 6)}...${recipient.slice(-4)} (<a href="https://etherscan.io/tx/${txHash}" target="_blank" class="text-blue-500">View</a>)`;
            txList.prepend(li);
            if (txList.children.length > 5) {
                txList.removeChild(txList.lastChild);
            }
        }

        document.getElementById('connectWallet').addEventListener('click', initWeb3);
        document.getElementById('sendPayment').addEventListener('click', sendPayment);
        document.getElementById('recipient').addEventListener('input', validateInputs);
        document.getElementById('amount').addEventListener('input', validateInputs);
        document.getElementById('paymentType').addEventListener('change', validateInputs);
        document.getElementById('paymentsTab').addEventListener('click', () => showTab('payments'));
        document.getElementById('newsTab').addEventListener('click', () => showTab('news'));
        document.getElementById('refreshNews').addEventListener('click', displayNews);

        window.ethereum?.on('accountsChanged', async (accounts) => {
            if (accounts.length > 0) {
                account = accounts[0];
                document.getElementById('walletStatus').innerText = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
                updateBalance();
            } else {
                document.getElementById('walletStatus').innerText = 'Wallet disconnected';
                document.getElementById('connectWallet').classList.remove('hidden');
                document.getElementById('paymentForm').classList.add('hidden');
            }
        });

        // Initialize news tab
        showTab('payments');
        displayNews();
    </script>
</body>
</html>